# -*- coding: utf-8 -*-
"""Prices_Prediction_incompleto

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fJNk4x4vKLp16yCH-p7cY8BrPUfc5ZtS
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error

df=pd.read_csv('/content/CarPrice_Assignment.csv')

df.head()

#Renomeando a coluna de marca de carros
df['car_brands']=df['CarName'].str.split(' ').str[0]
df.insert(1,'car_brands',df.pop('car_brands'))
df.head()

#Apagando as colunas desnecessárias para a análise
df.drop(['CarName', 'car_ID', 'symboling'], axis=1, inplace=True)

df.head()

df.info()

df['car_brands'].unique()

#Renomeando nome das marcas corretamente.

def fix_company_name(old_name, new_name):
    df['car_brands'].replace(old_name, new_name, inplace=True)

fix_company_name('maxda' , 'mazda')
fix_company_name('nissan' , 'Nissan')
fix_company_name('vw' , 'volkswagen')
fix_company_name('toyouta' , 'toyota')
fix_company_name('porcshce' , 'porsche')
fix_company_name('vokswagen' , 'volkswagen')

df['car_brands'].unique()

df['price'].describe()

#Análise das vendas
plt.title('company_sales')
df['car_brands'].value_counts().plot(kind='bar',color='blue',edgecolor='yellow')

plt.title('fueltype')
df['fueltype'].value_counts().plot(kind='pie',autopct='%1.1f%%',colors=['red','y'],explode=[0,0.3])

df.hist(figsize=(14,14))

df.head()

df.columns

df['fueltype'].unique()

df['enginetype'].unique()

df['cylindernumber'].unique()

df['drivewheel'].unique()

df['fuelsystem'].unique()

df['carbody'].unique()

df.head()

df.columns

# Configurando para int ou float as colunas que estão como dtype = 'object'

df['fueltype']=df['fueltype'].replace({'gas':1,'diesel':0}).astype(int)
df['doornumber']=df['doornumber'].replace({'two':2,'four':4}).astype(int)
df['aspiration']=df['aspiration'].replace({'std':1,'turbo':0}).astype(int)
df['drivewheel']=df['drivewheel'].replace({'fwd':1,'rwd':2,'4wd':3}).astype(int)

df['enginelocation' ]=df['enginelocation'].replace({'front':1,'rear':0}).astype(int)
df['cylindernumber']=df['cylindernumber'].replace({'two':2,'three':3,'four':4,'five':5,'six':6,'eight':8,'twelve':12}).astype(int)

enginetype_dummies=pd.get_dummies(df['enginetype'],drop_first=True,prefix='enginetype')
df=pd.concat([df,enginetype_dummies],axis=1)
df.drop('enginetype',axis=1,inplace=True)

carbody_dummies=pd.get_dummies(df['carbody'],drop_first=True,prefix='carbody')
df=pd.concat([df,carbody_dummies],axis=1)
df.drop('carbody',axis=1,inplace=True)

fuelsystem_dummies=pd.get_dummies(df['fuelsystem'],drop_first=True,prefix='fuelsystem')
df=pd.concat([df,fuelsystem_dummies],axis=1)
df.drop('fuelsystem',axis=1,inplace=True)

df.head()

len(df.columns)

df.info()

#Grafíco de calor
df_corr=df.select_dtypes(include=['int64','float64']).corr()
plt.figure(figsize=(15,14))
sns.heatmap(df_corr,annot=True,cmap='coolwarm', linewidths=0.01)
plt.title('Correlação dos preços do carros')
plt.show()

"""### Criando uma  variável indicadora para representar uma variável categórica (DUMMY)"""

df_with_dummies = pd.get_dummies(df, drop_first=True)
df_with_dummies.head()

"""#Modelo de regressão linear


"""

# Definindo y e X
x=df.drop(['price','car_brands'],axis=1)
y=df['price']

#Aplicando o split do y e X
from sklearn.model_selection import train_test_split

x_train, x_test, y_train, y_test = train_test_split(x,y, test_size=0.2, random_state=750)

Model=LinearRegression()
Model.fit(x_train, y_train)

#Dados de treino para usar a fórmula
df_train = pd.DataFrame(data= x_train)
df_train['car_brands'] = df.loc[x_train.index, 'car_brands']
df_train['price'] = y_train

from statsmodels.formula.api import ols

# Ajustando o modelo
modelo_0 = ols('price ~ car_brands', data = df_train).fit()

# visualizando os parametros
modelo_0.params

# o resumo do nosso modelo
print(modelo_0.summary())

# observando o R² (Coeficiente de determinação)
modelo_0.rsquared

# definindo o Y previsto

df_test = pd.DataFrame(data=x_test)
df_test['car_brands'] = df.loc[x_test.index, 'car_brands']

y_predict = modelo_0.predict(df_test)

# importando o r2_score
from sklearn.metrics import r2_score

# printando o r²
print("R²: ", r2_score(y_test,y_predict))

# importando a api do statsmodels
import statsmodels.api as sm

# adicionando o constante
x_train = sm.add_constant(x_train)

x_train.head()

x_train.columns

# Criando o modelo de regressão
modelo_1 = sm.OLS(y_train,
                  x_train[['curbweight','fueltype','enginesize','horsepower']]).fit()

print("Modelo_0: ", modelo_0.rsquared)

print("Modelo_1: ", modelo_1.rsquared)

# Obtendo o R² da previsão

x_test.columns

modelo_0.params

# Adicionando uma constante em X_test
x_test = sm.add_constant(x_test)
x_test['car_brands'] = df.loc[x_test.index, 'car_brands']
predict_0 = modelo_0.predict(x_test)

modelo_0.rsquared

# Qual o R² do treino?
print("R²: ", r2_score(y_test, predict_0))

#Calculando a precificação de um carro
modelo_1.params

#Preço do carro por Marca

price = pd.DataFrame({ 'const': [1],
                      'car_brands': ['honda'],'fueltype':[1]},
                      )

modelo_0.predict(price['car_brands'])

print(modelo_0.predict(price)[0])



